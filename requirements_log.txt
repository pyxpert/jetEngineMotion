================================================================================

九、今日更新记录 (2026-01-29)
================================================================================

1. [重要修正] 状态码第3位含义澄清
   - 问题：原理解中状态码第3位（ω3）表示中间旋转电机的目标角度状态
   - 修正：状态码第3位（ω3）实际表示中间旋转电机的运动状态
     * 0：电机停止（保持当前角度）
     * 1：电机正转（角度在变化）
     * 2：电机反转（角度在变化）
   - 影响：修正了电机动作逻辑与状态码的对应关系

2. [重要修正] 直线电机状态码含义澄清  
   - 问题：原理解中状态码第4位（v）表示直线电机的目标位置状态
   - 修正：状态码第4位（v）实际表示直线电机的运动状态
     * 0：电机停止（保持当前位置）
     * 1：电机正转（位置在增加）
     * 2：电机反转（位置在减少）
   - 影响：修正了直线电机动作逻辑与状态码的对应关系

3. [重要修正] 电机动作与状态码对应关系
   - 问题：在状态001101中，第3位为1表示中间电机正转，第4位为1表示直线电机正转
             但中间电机角度在该状态下并未变化，存在逻辑错误
   - 修正：正确映射电机动作与状态码的关系
     * 001001：中间电机正转（抬起磁铁，角度从0°→45°）
     * 000101：中间电机停止保持抬起状态（第3位为0），直线电机正转（第4位为1）
     * 002001：中间电机反转（放下磁铁，角度从45°→0°）
   - 效果：解决了电机状态与角度变化不一致的问题

4. [新增功能] 时间参数计算
   - 功能：为每个状态码计算持续时间（毫秒）
   - 计算依据：
     * 中间旋转电机角速度：90°/s
     * 直线电机动速度：15mm/s
   - 应用：每个状态的持续时间基于电机速度和位置/角度变化量计算

5. [重要修正] 磁铁抬起/放下机制
   - 机制：通过中间旋转电机角度变化实现磁铁抬起/放下
     * 抬起磁铁：中间电机正转（内折），状态码第3位为1
     * 保持抬起：中间电机停止，状态码第3位为0
     * 放下磁铁：中间电机反转（外翻），状态码第3位为2
   - 物理意义：通过旋转电机而非高度调节实现磁铁脱附/吸附

================================================================================
双节机器人运动规划系统 - 需求记录文档
================================================================================
创建时间: 2024
最后更新: 2025-01-22 (pyxpert 要求)

本文档记录用户在开发过程中提出的所有需求，作为开发和迭代的依据。

================================================================================
一、机器人结构需求
================================================================================

1. 机器人基本结构
   - 双节机器人，分为前后两节
   - 前后两节上表面都为长方形
   - 初始位置时两节上表面共面
   - 两节之间可发生相对位移和单轴旋转运动

2. 机器人尺寸参数
   - 前节长×宽: L1=40mm × W1=30mm
   - 后节长×宽: L2=40mm × W2=30mm  
   - 电磁铁底面到上表面高度: h=30mm
   - 直线电机最大行程: s_max=8mm
   - 电磁铁直径: 5mm（半径2.5mm）

3. 电机配置
   - ω1: 前节中心旋转电机，控制前节电磁铁相对于前节的角度
   - ω2: 后节中心旋转电机，控制后节电磁铁相对于后节的角度
   - ω3: 两节间旋转电机，控制两节相对角度
   - v: 丝杠电机，控制两节间相对位移

4. 电磁铁配置
   - 每节中心有一个圆柱形电磁铁
   - 吸力面在圆柱底面
   - 电磁铁与旋转电机同轴
   - 电磁铁轴线与所在节上表面垂直

5. 电机位置范围
   - θ1 (ω1电机): -360° 到 +360°
   - θ2 (ω2电机): -360° 到 +360°
   - θ3 (ω3电机): 0° 到 180°（0°为两节共面，增大为内折方向）
     * 0°：两节上表面共面，两个电磁铁底面共面
     * 180°：两节上表面贴在一起，两个电磁铁朝外
     * θ3始终为正，不能出现负值
   - s (v电机): 0mm 到 8mm

================================================================================
二、运动约束需求
================================================================================

1. 电磁铁状态约束
   - 两个电磁铁都ON时：所有电机必须停止（机器人固定）
   - 两个电磁铁不能同时OFF（安全考虑，防止机器人滑落）

2. 电机运动约束
   - 一个电磁铁OFF、一个ON时：
     * OFF的节可以移动（通过ω3、v）
     * ON的节可以相对于其电磁铁旋转（通过ω1或ω2）
     * OFF节的ω电机也可以旋转，用于避免角度累积超出±360°范围
       （注：用户修正了之前"OFF节ω电机旋转无意义"的说法）

3. 直线蠕动运动约束（重要）
   - 直线蠕动运动时（沿Z轴方向前进），只操控θ3、v和m1、m2
   - 直线蠕动运动时，ω1和ω2必须保持为0（电磁吸盘完全不需要旋转）
   - 抬起一足的动作永远是中间电机（ω3）的内折动作（θ3增大）
   - θ3在直线蠕动中始终处于内折状态，不能出现负值

4. ω3旋转轴位置
   - ω3旋转轴始终与前后两节上表面的交线共线
   - 当ω3旋转时，两节呈"折叠"状态，后节上表面会倾斜

================================================================================
三、环境模型需求
================================================================================

1. 航空发动机/燃气轮机内腔
   - 圆柱形内壁
   - 内表面半径: 900mm（恒定）
   - 圆柱内壁总长度: 1000mm（Z轴范围0-1000mm）

2. 叶片障碍物
   - 共四级叶片
   - 分布位置: 200mm、400mm、600mm、800mm
   - 叶片不可攀爬，视为障碍物
   - 叶片之间有通道可供机器人通过

================================================================================
四、初始/终止状态需求
================================================================================

1. 机器人初始位置（3D坐标）
   - 前足起始点: X=0, Y=-900, Z=40 mm
   - 后足起始点: X=0, Y=-900, Z=0 mm
   - 双足皆处于圆柱内壁最底端

2. 机器人初始状态
   - 各电机初始位置都为0
   - 直线电机行程为0
   - 机器人朝向：后足指向前足的方向为Z减小的方向

3. 机器人终止位置
   - 前足终点: X=0, Y=-900, Z=1000 mm
   - 前足到达终点后即视为运动过程结束（不需要后足也到达终点）

4. 前后足位置关系
   - 前后足在物理上不能处于同一位置
   - 初始时前足Z=40mm，后足Z=0mm，两者相距40mm
   - 运动过程中前后足始终保持一定距离

================================================================================
五、输出格式需求
================================================================================

1. 状态码格式
   - 六位状态数组: ω1ω2ω3vm1m2
   - 旋转电机和丝杠电机：0=停止, 1=正转, 2=反转
   - 电磁铁：0=脱附(OFF), 1=吸附(ON)
   - 配合持续时间t

2. 输出文件要求
   - JSON格式文件
   - 制表符分隔的文本文档（表格形式）

3. 表格内容要求
   - 每一步运动完成后记录各电机位置
   - θ1: 前节旋转电机角度
   - θ2: 后节旋转电机角度
   - θ3: 中间旋转电机角度
   - s: 直线电机行程
   - 包含初始状态和最终汇总信息
   - 显示位置警告（接近极限时）
   - **吸附磁铁位置**：记录当前吸附在壁面上的电磁铁的3D坐标 (X, Y, Z)

================================================================================
六、可视化需求
================================================================================

1. 发动机腔体可视化
   - 水平放置（躺下来），口朝水平方向
   - 机器人轨迹在内腔表面
   - 叶片在发动机内部，向内延伸
   - **补全圆柱壁面**：显示完整的圆柱表面，不再只显示底部

2. 机器人结构可视化
   - 生成机器人结构示意图
   - 能够看到电磁铁的圆柱特征（直径5mm）
   - 电磁铁轴线与上表面垂直

3. 特定状态可视化
   - 初始状态: θ3=0°, s=0mm
   - 状态1: θ3=45°, s=0mm（内折45°）
   - 状态2: θ3=90°, s=s_max(8mm)（内折90°，最大行程）
   - 状态3: θ3=90°, s=0mm（内折90°）
   - 状态4: s=s_max, θ3=0°（最大行程，共面）

4. 交互式3D可视化
   - 弹出窗口形式显示
   - 支持鼠标旋转、缩放查看
   - 不仅保存到文件

5. 轨迹可视化
   - 前足轨迹和后足轨迹用不同颜色区分
   - 叶片图例只标注一个（避免重复）
   - **轨迹线**：按步序顺序连接前足/后足的吸附落点

6. 电磁铁可视化细节
   - 仅θ3=0°时两个电磁铁底面共面
   - θ3旋转时，电磁铁轴线始终垂直于其所在节的上表面

7. 3D图像比例尺要求
   - 各轴(X, Y, Z)的比例尺必须一致
   - 不要为了使整个图像呈正方体而修改各轴比例尺
   - 保持真实的几何比例关系

================================================================================
七、技术实现需求
================================================================================

1. 解决导入问题
   - matplotlib和mpl_toolkits.mplot3d的导入错误
   - 通过pip install matplotlib numpy解决

2. 解决中文显示问题
   - 图像中的方框/乱码问题
   - 改用英文标签

3. 坐标系统
   - 支持3D笛卡尔坐标和圆柱面坐标转换
   - X, Y为径向坐标
   - Z为轴向坐标

================================================================================
八、需求变更记录
================================================================================

1. [变更] "OFF节ω电机旋转无意义"
   - 用户修正：OFF节的ω电机可以旋转，用于避免旋转角度超出±360°范围

2. [变更] 圆柱内壁长度
   - 修改为：1000mm

3. [变更] 叶片分布
   - 修改为：四级，位于200mm、400mm、600mm、800mm

4. [修正] 前后足起始位置
   - 修正：前足起始Z=40mm，后足起始Z=0mm，两者相距40mm

5. [明确] 运动结束条件
   - 前足到达终点(Z=1000mm)后即视为运动过程结束

6. [修正] 蠕虫式爬行算法
   - 修正：实现完整的蠕虫式爬行周期

7. [修正] 可视化中前后足起点/终点位置
   - 修正：可视化函数正确传入并使用前后足的起始Z坐标和目标Z坐标

8. [移除] Motion State Sequence图
   - 图表混乱且无实用价值，不再生成

9. [修正] 叶片障碍物的避障逻辑
   - 修正：机器人必须在周向上绕过叶片，不能直接轴向穿过

10. [重要修正] θ3角度范围定义
    - 修正：θ3范围改为0°到180°，确保θ3始终为正（内折）

11. [重要修正] 直线蠕动运动逻辑
    - 修正：直线蠕动运动时，ω1和ω2必须保持为0
    - 修正：直线蠕动运动只操控θ3、v和m1、m2

12. [优化] 直线电机行程利用率
    - 修正：单步丝杠行程从80%（6.4mm）优化为95%（7.6mm）

13. [修正] 位置计算逻辑
    - 修正：在直线蠕动运动中，当丝杠运动时实时更新未吸附足的Z坐标

14. [可视化需求] 3D Path Visualization图像改进
    - 要求：补全圆柱壁面，并绘制前/后足的运动轨迹

15. [修正] 3D和2D路径图像一致性
    - 修正：2D图像终点标记改为使用目标点坐标，确保显示Z=1000mm

16. [优化] 运动规划总步数上限提升
    - 修正：提升至3000步

17. [重要修正] 电机转速一致性与安全控制
    - 修正：在直线蠕动运动中，ω3旋转到预定翻折角后必须立即停转

18. [重要修正] 运动学计算模型 (pyxpert 要求)
    - 要求：严格执行PDF文档中的“小圆与椭圆求交点”算法
    - 修正：确保机器人绕吸附足旋转后的落点计算准确，实时更新前进方向角 φ

19. [重要修正] 直线蠕动规划初始化 (pyxpert 要求)
    - 问题：前 16 步动作包含无意义的吸盘旋转，不符合直线运动逻辑。
    - 修正：直线蠕动规划必须从第一步起就严格遵循“θ3内折 -> v位移 -> θ3展开”的顺序，严禁在直线运动中旋转吸盘（ω1、ω2 必须保持为 0）。
    - 修正：移除所有在直线蠕动开始阶段产生的周向修正动作。

20. [重要修正] 坐标更新失效问题 (pyxpert 要求)
    - 问题：生成的 motion_plan_table.txt 中前后足坐标完全没有变化。
    - 修正：修复 `robot_motion_planner.py` 中的运动学计算集成逻辑，确保每一步运动（尤其是丝杠位移和 θ3 翻折）都能实时且准确地反映在前后足的 3D 坐标上。
    - 修正：确保在 `save_plan_table` 过程中，根据当前的 φ、a 和 θ3 状态，通过“小圆椭圆求交点”算法重新计算并记录足端落点。

================================================================================
文档说明
================================================================================

此文档由 pyxpert 提出需求，AI 助手负责记录和更新。

每次更新时会：
1. 添加新的需求到相应分类
2. 记录需求变更（如有）
3. 更新时间戳

================================================================================
九、今日更新记录 (2026-01-28)
================================================================================

1. [重要修正] 椭圆-圆求交点算法精度提升
   - 问题：原算法使用遍历方法精度较低（约1e-4）
   - 修正：改用解析解法，精度提升至1e-14
   - 效果：显著提高足部落点位置计算的准确性

2. [重要修正] φ角定义澄清
   - 问题：代码注释中φ≈90°被错误地描述为纯轴向运动
   - 修正：φ=0°为纯轴向运动，±90°为纯周向运动
   - 影响：修正了椭圆方程及相关计算逻辑

3. [重要修正] 小圆半径计算方法
   - 问题：原计算方法使用线性相加（如d1+h），几何上不准确
   - 修正：改用勾股定理计算实际空间距离
     * 寻找前足时（后足固定）：r_circle = √(d1² + h²) 
     * 寻找后足时（前足固定）：r_circle = √((a+d2)² + h²)
   - 效果：几何关系更加准确，修正后半径差异显著（例如情况1差异13.9mm，情况2差异23.8mm）

4. [新增功能] 路径合理性验证算法
   - 功能：验证给定路径是否符合机器人机械约束和几何约束
   - 验证内容：
     * 机械约束：两足间轴向距离在[d1+d2, d1+d2+s_max]范围内
     * 几何约束：每步移动是否符合椭圆-圆求交点算法
     * 运动连续性：是否满足蠕虫式爬行模式
   - 应用：可判断任意路径序列是否可被机器人实现

5. [概念阐述] x0在椭圆-圆求交点算法中的含义
   - x0：椭圆与小圆交点在椭圆坐标系中的x坐标值
   - 用途：用于计算位置增量 ΔX = x0·cos(φ) 和 Δθ = arctan(x0·sin(φ)/y0)
   - 物理意义：表示在前进方向上的相对位移量

6. [完善] 机器人运动坐标求解方法
   - 坐标系定义：圆柱坐标系(θ,z)与笛卡尔坐标系(x,y,z)的转换
   - 坐标变换：机器人局部坐标系与全局坐标系的转换
   - 坐标更新：运动规划中的坐标更新时机和方法
   - 约束条件：电磁铁状态约束、电机运动约束、运动学约束等

================================================================================
